=============
Desktop HOWTO (c) Nicolas Kovacs <info@microlinux.fr>
=============

Dernière révision : 3 juillet 2013

Ce HOWTO décrit l'installation d'un poste de travail Microlinux Entreprise basé
sur Slackware 14.0.


  * Démarrage et choix du clavier
  * Récupérer les tagfiles
  * Partitionner le disque dur
  * Formater le disque dur
  * Choisir ce qu'on va installer
  * Configurer LILO
  * Configurer la souris
  * Configurer le réseau et les services au démarrage
  * Configurer l'horloge et le fuseau horaire
  * Choisir un gestionnaire de fenêtres
  * Avant de redémarrer
  * Peaufiner la configuration réseau
  * Récupérer les scripts Microlinux
  * Configurer 'slackpkg'
  * Élaguer le système de base
  * Installer la collection de paquets MLED
  * Installer les paquets Multilib
  * Nettoyer le menu des applications
  * Terminer l'installation
  * Nettoyer une installation existante


Démarrage et choix du clavier
-----------------------------
 
Options de démarrage :

  * 'hugesmp.s' -> 32bit
  * 'huge.s'    -> 64bit ou vieux PC ne supportant pas 'hugesmp.s'
  * 'vga=788'   -> écran normal
  * 'vga=791'   -> grand écran

Choix du clavier : 'azerty/fr-latin1.map' pour un clavier AZERTY français.


Récupérer les tagfiles
----------------------

Les tagfiles sont une série de fichiers texte qui définissent le statut d'un
paquet. Un paquet marqué 'ADD' sera installé, un paquet marqué 'SKP' ne le sera
pas. Cette procédure permet d'éviter la sélection manuelle des paquets.

Activer le réseau, par exemple :

  root@slackware:/# dhcpcd eth0

L'environnement d'installation de Slackware contient déjà un répertoire '/tag',
censé recevoir l'arborescence des tagfiles :

  # cd /tag

Récupérer les tagfiles du serveur de Microlinux :

  wget http://www.microlinux.fr/slackware/MLED-14.0-32bit/tagfiles.tar.gz

  /!\ Les jeux de tagfiles dans les sous-répertoires 32-bit et 64-bit sont des
  liens symboliques et de fait identiques.

Décompresser l'archive :

  # tar xvzf MLED-14.0.tar.gz

Si tout s'est bien passé, le répertoire '/tag' contient une série de
répertoires correspondant aux groupes de paquets Slackware :

  root@slackware:/tag# ls
  a/ ap/ d/ e/ f/ k/ kde/ kdei/ l/ n/ t/ tcl/ x/ xap/ xfce/ y/

À présent, on peut lancer l'installateur :

  root@slackware:/tag# setup


Partitionner le disque dur
--------------------------

Remettre les tables de partitions à zéro :

  # dd if=/dev/zero of=/dev/sda bs=512 count=64

Partitionner le disque :

  # cfdisk /dev/sda

Schéma de partitionnement :

  * une partition pour /boot, de 100 Mo, formaté en ext2
  * une partition swap, égale à la quantité de RAM disponible
  * une partition principale, formatée en ext4

  > Si l'on dispose de moins de 512 Mo de RAM, la swap sera égale à deux fois
    la quantité de RAM.

  > Si l'on a au moins 512 Mo de RAM, la swap sera égale à la quantité de RAM.

  > La partition swap sera de type 'Linux swap' (code 82).

  > Toutes les autres partitions seront de type 'Linux' (code 83).


Formater le disque dur
----------------------

Toutes les opérations de formatage s'effectuent sans la recherche méticuleuse
de secteurs défectueux.

  /!\ L'installateur Slackware requiert de partitionner la partition principale
  en premier !

Consignes pour le formatage :

  > système de fichiers ext2 pour '/boot'

  > système de fichiers ext4 pour les autres : '/', '/home', ...


Choisir ce qu'on va installer
-----------------------------

Installer à partir du CD-Rom ou du DVD Slackware.

Rechercher le lecteur CD-Rom ou DVD.

PACKAGE SERIES SELECTION: accepter la sélection par défaut, puisque le profil
de l'installation sera défini par les tagfiles.

SELECT PROMPTING MODE: 'tagpath', puis indiquer le chemin vers les tagfiles.

  /!\ Si l'on ne peut pas utiliser les tagfiles pour une raison ou pour une
  autre, on peut toujours désélectionner les groupes E, KDE et XAP, installer
  les groupes A, AP, D, F, K, L, N, T, TCL, X, XFCE et Y et peaufiner
  l'installation de base après coup.


Configurer LILO
---------------

MAKE USB FLASH BOOT : 'Skip making a USB boot stick'

INSTALL LILO : 'Try to install LILO automatically'

CONFIGURE LILO TO USE FRAME BUFFER CONSOLE : 'standard - Use the standard Linux
console (the safe choice). 

OPTIONAL LILO append="<kernel parameters>" LINE : 

  * 'nomodeset quiet ipv6.disable=1' 
  * 'quiet ipv6.disable=1 video=1366x768' (carte Intel)
  * résolutions courantes : 800x600, 1024x768, 1366x768

USE UTF-8 TEXT CONSOLE : 'Yes' - UTF8 a beau avoir quelques petits problèmes
avec certains utilitaires en mode console, il n'empêche qu'il est dorénavant
établi comme standard un peu partout. Le choix par défaut 'No' s'explique
uniquement par un excès de prudence de la part du distributeur.

SELECT LILO DESTINATION : 'MBR - Install to Master Boot Record'


Configurer la souris
--------------------

MOUSE CONFIGURATION : 'imps2- Microsoft PS/2 Intellimouse'

  > La configuration de la souris ne concerne que son utilisation en mode
    console, avec GPM. On peut simplement accepter le choix par défaut, qui
    correspond à toutes les souris modernes.

GPM CONFIGURATION : 'No'. Le service GPM permet de copier/coller du texte avec
la souris en mode console. Étant donné que nous nous servons de Vim pour cela,
nous décidons de ne pas le démarrer.


Configurer le réseau et les services au démarrage
-------------------------------------------------

CONFIGURE NETWORK: 'Yes'

ENTER HOSTNAME : il s'agit de choisir un nom d'hôte pour la machine.
Choisissez-en un à votre convenance et écrivez-le en minuscules, comme ceci :
  
  * 'slackbox'
  * 'alphamule'
  * 'grossebertha'
  * 'raymonde'
  * 'poste10'
  *  etc.

ENTER DOMAINNAME FOR '<machine>' : choisissez un nom de domaine pour la
machine, comme par exemple :

  * 'local'
  * 'microlinux.montpezat'
  * 'crpconsulting.montpellier'
  *  etc.

  /!\ Sur un poste de travail dont le nom d'hôte est géré de façon centralisée
  par le serveur DHCP, on choisira 'localhost' et 'localdomain'. 

CONFIGURATION TYPE FOR '<machine.domaine>' : selon le contexte, on choisira
'static IP' ou 'DHCP' pour une connexion cablée sur un serveur ou un poste de
travail. Sur un ordinateur portable qui fonctionne alternativement avec une
connexion wifi ou cablée ou en mode "nomade", on préférera 'NetworkManager',
une application qui gère la connexion "automagique" du réseau. 

SET DHCP HOSTNAME : nom d'hôte DHCP à envoyer au FAI pour une connexion.
Laisser vide tout simplement.

CONFIRM STARTUP SERVICES TO RUN :

  [*] rc.fuse       -> laisser la sélection telle quelle
  [*] rc.inetd
  [*] rc.messagebus
  [*] rc.syslog
  [*] rc.sshd


Configurer l'horloge et le fuseau horaire
-----------------------------------------

HARDWARE CLOCK SET TO UTC ? 'YES - Hardware clock is set to UTC'

  /!\ Le seul cas de figure où l'on optera pour 'local time', c'est dans un
  scénario de double boot avec Windows, pour éviter que ce dernier ne dérègle
  l'horloge à chaque redémarrage.

TIMEZONE CONFIGURATION : 'Europe/Paris'


Choisir un gestionnaire de fenêtres
-----------------------------------

SELECT DEFAULT WINDOW MANAGER FOR X : 'xinitrc.twm'

  /!\ Peu importe ce que l'on sélectionne ici. Un peu plus loin, on installera
  Fluxbox pour configurer le serveur graphique plus aisément qu'avec cette
  immonde bouse TWM.


Avant de redémarrer
-------------------

Quitter l'installateur ('EXIT') et construire un Initrd avant le premier
redémarrage.

  # chroot /mnt

Voir le Generic-Kernel-HOWTO et le LILO-HOWTO pour les détails.

Quitter l'environnement chrooté et redémarrer :

  # exit
  # reboot


Peaufiner la configuration réseau
---------------------------------

Après le premier redémarrage, corriger la configuration de l'installateur dans
'/etc/hosts' si l'on gère les noms d'hôte de façon centralisée :

--8<---------- /etc/hosts ----------------------------------------------------
127.0.0.1     localhost.localdomain localhost
--8<--------------------------------------------------------------------------

Si l'on vient d'installer Slackware sur un portable avec le wifi mais sans
cable Ethernet, on peut éditer '/etc/rc.d/rc.inet1.conf' pour une connexion
provisoire. Une connexion WEP ressemblera à ceci, par exemple :

--8<---------- /etc/rc.d/rc.inet1.conf ---------------------------------------
# Config information for eth1:
IPADDR[1]=""
NETMASK[1]=""
USE_DHCP[1]="yes"
DHCP_HOSTNAME[1]=""
WLAN_ESSID[1]="monessid"
WLAN_KEY[1]="d5ad1f04acf048ec2d0b1c80c7"
--8<--------------------------------------------------------------------------

  /!\ Éditer la configuration avec l'option ':set nobackup' dans Vim, pour
  éviter de se retrouver avec une série de fichiers de sauvegarde '*.conf~'.


Récupérer les scripts Microlinux
--------------------------------

Les scripts sont stockés dans un dépôt Github :

  # cd
  # git clone https://github.com/kikinovak/slackware


Configurer 'slackpkg'
---------------------

Télécharger l'extension 'slackpkg+' pour 'slackpkg'. C'est un outil fort
pratique pour gérer les dépôts de paquets tiers comme MLED :

  # links http://slakfinder.org/slackpkg+

Récupérer le paquet dans le répertoire 'pkg/' et l'installer.

Éditer '/etc/slackpkg/mirrors' et choisir un miroir de téléchargement en
fonction de l'emplacement géographique. Par exemple :

--8<---------- /etc/slackpkg/mirrors -----------------------------------------
...
# FRANCE (FR)
ftp://mirror.ovh.net/mirrors/ftp.slackware.com/slackware64-14.0/
...
--8<--------------------------------------------------------------------------

  /!\ Assurez-vous de ne choisir qu'un seul miroir pour la version stable.

Configurer 'slackpkg+' :

  # cd /etc/slackpkg
  # mv slackpkgplus.conf slackpkgplus.conf.orig

Sur Slackware 32-bits :

--8<---------- /etc/slackpkg/slackpkgplus.conf -------------------------------
# /etc/slackpkg/slackpkgplus.conf
SLACKPKGPLUS=on
VERBOSE=2
PKGS_PRIORITY=( microlinux:.* )
REPOPLUS=( microlinux slackpkgplus )
MIRRORPLUS['microlinux']=http://www.microlinux.fr/slackware/MLED-14.0-32bit/
MIRRORPLUS['slackpkgplus']=http://slakfinder.org/slackpkg+/
--8<--------------------------------------------------------------------------

Sur Slackware64:

--8<---------- /etc/slackpkg/slackpkgplus.conf -------------------------------
# /etc/slackpkg/slackpkgplus.conf
SLACKPKGPLUS=on
PKGS_PRIORITY=( microlinux:.* )
REPOPLUS=( microlinux slackpkgplus )
MIRRORPLUS['microlinux']=http://www.microlinux.fr/slackware/MLED-14.0-64bit/
MIRRORPLUS['slackpkgplus']=http://slakfinder.org/slackpkg+/
--8<--------------------------------------------------------------------------

Eric Hameleers a la gentillesse de fournir un miroir pour le dépôt Microlinux,
que l'on peut donc configurer alternativement :

  * http://taper.alienbase.nl/mirrors/people/kikinovak/

Mettre à jour les clés GPG :

  # slackpkg update gpg

Mettre à jour les informations sur les paquets disponibles :

  # slackpkg update


Élaguer le système de base
--------------------------

Si l'on n'a pas utilisé les tagfiles pour l'installation du système de base, le
moment est venu de rattraper le peaufinage du système de base. Le répertoire
'tools/' contient un script simple 'trim-desktop-base.sh' qui s'occupe
essentiellement de deux choses :

  1. installer les paquets de base nécessaires
  2. supprimer les paquets superflus

Le script utilise 'slackpkg', il faut donc s'assurer de l'avoir correctement
configuré.

  # cd slackware/MLED-14.0-32bit/tools
  # ./trim-desktop-base.sh

  /!\ Cette dernière commande installe une série de paquets, notamment une
  poignée d'applications du groupe XAP. Elle en supprime aussi quelques-uns,
  comme par exemple les polices de caractères inutiles du groupe X. Pour plus
  de détails, jeter un oeil sur les fichiers 'desktop-base-add' et
  'desktop-base-remove' dans le répertoire 'tools/pkglists'.


Installer la collection de paquets MLED
---------------------------------------

Utilisez le script 'install-MLED.sh' dans le répertoire 'tools/' :

  # cd tools/
  # ./install-MLED.sh

Ce script lit les informations contenues dans le fichier 'packages-MLED' situé
dans le répertoire 'pkglists' et installe "à la louche" l'ensemble des paquets
contenus dans cette liste, en utilisant 'slackpkg'.

  /!\ De temps en temps, de nouveaux paquets sont ajoutés à MLED. Pour rester à
  jour avec votre installation, il vous suffit de réinvoquer le script
  'install-MLED.sh'. Au préalable, il vous faudra bien évidemment mettre à jour
  le contenu du dépôt Github. Pour ce faire, allez à la racine des fichiers
  téléchargés ('/root/slackware' dans l'exemple') et invoquez 'git pull'.


Installer les paquets Multilib
------------------------------

Sur Slackware64, vous voudrez peut-être ajouter des applications comme
VirtualBox, Wine ou Skype, etc. Dans ce cas, il faudra installer la couche de
compatibilité 32-bits fournie par Eric Hameleers. Le plugin 'slackpkg+' rend
cette tâche extrêmement facile.

Dans un premier temps, ajoutez le dépôt Multilib :

--8<---------- /etc/slackpkg/slackpkgplus.conf -------------------------------
...
REPOPLUS=( ... multilib )
MIRRORPLUS['multilib']=http://taper.alienbase.nl/mirrors/people/alien/multilib/14.0/
...
--8<--------------------------------------------------------------------------

Le dépôt Multilib est prioritaire par rapport aux paquets Slackware officiels :

--8<---------- /etc/slackpkg/slackpkgplus.conf -------------------------------
...
PKGS_PRIORITY=( ... multilib:.* )
...
--8<--------------------------------------------------------------------------

Voici à quoi ressemble notre fichier de configuration au total :

--8<---------- /etc/slackpkg/slackpkgplus.conf -------------------------------
# /etc/slackpkg/slackpkgplus.conf
SLACKPKGPLUS=on
PKGS_PRIORITY=( microlinux:.* multilib:.* )
REPOPLUS=( microlinux slackpkgplus )
MIRRORPLUS['microlinux']=http://mirror.nestor/microlinux/MLED-14.0-64bit/
MIRRORPLUS['multilib']=http://taper.alienbase.nl/mirrors/people/alien/multilib/14.0/
MIRRORPLUS['slackpkgplus']=http://slakfinder.org/slackpkg+/
--8<--------------------------------------------------------------------------

Mettez à jour le système :

  # slackpkg update gpg
  # slackpkg update
  # slackpkg upgrade-all

  /!\ Cette dernière commande remplacera tous les paquets gcc-* et glibc-*
  standard par les versions Multilib fournies par Eric.

À présent, installez la panoplie complète de paquets de compatibilité 32-bits.
Cette opération peut être effectuée tout simplement comme ceci :

  # slackpkg install compat32


Nettoyer le menu des applications
---------------------------------

Le répertoire 'tools/' contient entre autres choses un script 'cleanmenu'. Son
rôle est de nettoyer et de simplifier les entrées du menu des applications,
afin que Mme Michu s'y retrouve. Lancer ce script :

  # cd tools/
  # ./cleanmenu

  /!\ Le script remplace une bonne partie des fichiers '*.desktop' situés dans
  '/usr/share/applications' et autres emplacements par des entrées de menu
  "maison". Pour l'instant, ces fichiers ont été traduits en anglais, en
  français et en allemand. Évitez de lancer 'cleanmenu' si vous utilisez une
  autre langue pour votre environnement de bureau.


Terminer l'installation
-----------------------

Éventuellement, synchroniser le poste avec le serveur NTP local (NTP-HOWTO).

Configurer le serveur graphique.

Définir le ou les utilisateurs du système. Si l'on utilise l'authentification
centralisée, c'est le moment de la configurer.

  # adduser

Passer en init 4.


Nettoyer une installation existante
-----------------------------------

S'il ne s'agit pas d'une installation fraîche de Slackware 14.0, mais d'un
système existant, ce n'est pas la peine de tout réinstaller. Il suffit de
nettoyer le système existant pour partir du bon pied.

Passer en init 3.

Nettoyer '/tmp'.

Sur un système Slackware64, supprimer les paquets multilib. Commenter la ligne
correspondante dans '/etc/slackpkg/blacklist' ou alors supprimer la
configuration correspondante dans '/etc/slackpkg/slackpkgplus.conf'.

Ensuite, "mettre à jour" tous les paquets gcc-* et glibc-*, ce qui les remplace
par les versions 64-bit pures.

  # slackpkg upgrade-all

Supprimer tout ce qui reste éventuellement dans '/etc/slackpkg/blacklist'

Supprimer les paquets multilib restants :

  # removepkg compat32-tools
  # cd /var/log/packages
  # removepkg *compat32*

Supprimer tous les paquets tiers :

  # slackpkg clean-system

Le cas échéant, supprimer les paquets qui remplacent des paquets officiels :

  # cd /var/log/packages
  # removepkg *microlinux*       

Supprimer les groupes de paquets inutiles :

  # slackpkg remove e kde kdei xap

Installer les groupes de paquets requis :

  # slackpkg install a ap d f k l n t tcl x xfce y

Peaufiner le profil du système de base :

  # cd tools/
  # ./trim-desktop-base.sh


------------------------------------------------------------------------------
# vim: syntax=txt
# vim: set encoding=latin1
